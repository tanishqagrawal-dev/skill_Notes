rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- Helper Functions ---
    function isSignedIn() {
      return request.auth != null;
    }
    
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    
    function hasRole(role) {
      return isSignedIn() && getUserData().role == role;
    }

    // --- Colleges Collection ---
    match /colleges/{collegeId} {
      allow read: if true; // Everyone can see colleges
      allow write: if hasRole('admin') || hasRole('superadmin');
    }

    // --- Users Collection ---
    match /users/{userId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() && (request.auth.uid == userId);
      allow update: if hasRole('admin') || hasRole('superadmin') || (request.auth.uid == userId && !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role', 'college']));
      allow delete: if hasRole('admin') || hasRole('superadmin');
    }

    // --- College Admins Mapping ---
    match /college_admins/{collegeId} {
      allow read: if true;
      allow write: if hasRole('admin') || hasRole('superadmin');
    }

    // --- Consolidated Notes Collection ---
    match /notes/{noteId} {
      // Access Rule: Everyone can read approved notes, Co-Admins can read their college's notes
      allow read: if resource.data.status == 'approved' || 
                   (isSignedIn() && (
                     hasRole('admin') || 
                     hasRole('superadmin') || 
                     (hasRole('coadmin') && resource.data.college == getUserData().college) ||
                     resource.data.uploadedBy == request.auth.uid
                   ));

      // Creation Rule: Signed in users can upload
      allow create: if isSignedIn();

      // Update Rule: Only Admin or the designated Co-Admin for that specific college
      allow update: if hasRole('admin') || hasRole('superadmin') || (
                      hasRole('coadmin') && 
                      getUserData().college == resource.data.college &&
                      request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status', 'approvedBy', 'rejectionReason'])
                    );

      allow delete: if hasRole('admin') || hasRole('superadmin');
    }

    // --- Role Invites ---
    match /role_invites/{emailId} {
      allow read, delete: if isSignedIn();
      allow write: if hasRole('admin') || hasRole('superadmin');
    }

    // --- Analytics (Global Standard) ---
    match /analytics/{docId} {
      allow read: if true;
      allow write: if true; // Allow everyone (including guests) to increment global counters
    }

    // --- Legacy Stats (Deprecated but kept for safety) ---
    match /stats/{statId} {
      allow read: if true;
      allow update: if true; 
      allow create, delete: if hasRole('admin') || hasRole('superadmin');
    }

    match /support_queries/{queryId} {
      allow create: if true;
      allow read, write: if hasRole('admin') || hasRole('superadmin');
    }

    match /presence/{userId} {
      allow read: if true;
      allow write: if isSignedIn() && request.auth.uid == userId;
    }
  }
}
