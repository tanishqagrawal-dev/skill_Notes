rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- Helper Functions ---
    function isSignedIn() {
      return request.auth != null;
    }
    
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    
    function hasRole(role) {
      return isSignedIn() && getUserData().role == role;
    }

    // --- Colleges Collection ---
    match /colleges/{collegeId} {
      allow read: if true; // Everyone can see colleges
      allow write: if hasRole('admin') || hasRole('superadmin');
    }

    // --- Users Collection ---
    match /users/{userId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() && (request.auth.uid == userId);
      allow update: if hasRole('admin') || hasRole('superadmin') || (request.auth.uid == userId && !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role', 'college']));
      allow delete: if hasRole('admin') || hasRole('superadmin');
    }

    // --- College Admins Mapping ---
    match /college_admins/{collegeId} {
      allow read: if true;
      allow write: if hasRole('admin') || hasRole('superadmin');
    }

    // --- Notes Collection (Unified) ---
    match /notes/{noteId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update, delete: if request.auth != null && request.auth.uid == resource.data.uploadedBy;
    }

    // --- Notes Pending ---
    match /notes_pending/{noteId} {
      allow read: if isAdmin() || 
                  (isCoAdmin() && (resource.data.collegeId == getUserData().collegeId || resource.data.college == getUserData().college)) ||
                  (isSignedIn() && resource.data.uploaderUid == request.auth.uid);
                  
      allow create: if isSignedIn(); // Anyone can upload
      
      allow update: if isAdmin() || 
                    (isCoAdmin() && (resource.data.collegeId == getUserData().collegeId || resource.data.college == getUserData().college));
                    
      allow delete: if isAdmin() || 
                    (isCoAdmin() && (resource.data.collegeId == getUserData().collegeId || resource.data.college == getUserData().college));
    }

      // Creation Rule: Signed in users can upload
      allow create: if isSignedIn();

      // Update Rule: Only Admin or the designated Co-Admin for that specific college
      allow update: if hasRole('admin') || hasRole('superadmin') || (
                      hasRole('coadmin') && 
                      getUserData().college == resource.data.collegeId &&
                      request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status', 'approvedBy', 'rejectionReason'])
                    );

      allow delete: if hasRole('admin') || hasRole('superadmin');
    }

    // --- Role Invites ---
    match /role_invites/{emailId} {
      allow read, delete: if isSignedIn();
      allow write: if hasRole('admin') || hasRole('superadmin');
    }

    // --- Stats & Others ---
    match /stats/{statId} {
      allow read: if true;
      allow write: if hasRole('admin') || hasRole('superadmin') || hasRole('coadmin');
    }

    match /support_queries/{queryId} {
      allow create: if true;
      allow read, write: if hasRole('admin') || hasRole('superadmin');
    }

    match /presence/{userId} {
      allow read: if true;
      allow write: if isSignedIn() && request.auth.uid == userId;
    }
  }
}
